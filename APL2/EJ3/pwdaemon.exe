Param(
    [Parameter(Mandatory=$true)]
    [string] $codigo,

    [Parameter(Mandatory=$true)]
    [string] $acciones,
    
    [Parameter]
    [string] $salida
)

function Compile() {
    Param(
        [string] $rootPath
    )
    Write-Host "In Compile function $rootPath"    
    dir "$rootPath*" -rec | gc | Out-File ./bin/output.txt
}

function Publish() {
    Param(
        [string] $output
    )
}

$daemon = New-Object -TypeName System.IO.FileSystemWatcher -Property @{
    Path = $codigo
    IncludeSubdirectories = $true
}

$actionHandler = {
    $actions = $acciones.Split(',')
    $details = $event.SourceEventArgs
    $Name = $details.Name
    $FullPath = $details.FullPath
    $Path = $details.Path
    $Size = (Get-Item $FullPath).length
    $OldName = $details.OldName
    

    Write-Host "$Name $FullPath $Size $Path"
    Write-Host "$actions"
    
    if ($actions.Contains('listar')) {
        Write-Host "File: {0}" -f $Name
    }
    
    Write-Host "cant pass if??"
    
    if ($actions -contains 'peso') {
        Write-Host "Size: {0}" -f $Size
    }
    
    if ($actions -contains 'compilar') {
        Write-Host "Compiling $Path"
        Compile $codigo
        <#
        if($actions.Contains("publicar")) {
            Publish $pushPath
        }
        #>
    }
    
    foreach ($act in $actions) {
        Write-Host "Acciont $act"
    }
}

$handlers = . {
    Register-ObjectEvent -InputObject $daemon -EventName Created -Action $actionHandler
    Register-ObjectEvent -InputObject $daemon -EventName Changed -Action $actionHandler
    Register-ObjectEvent -InputObject $daemon -EventName Deleted -Action $actionHandler
    Register-ObjectEvent -InputObject $daemon -EventName Renamed -Action $actionHandler
}

$daemon.EnableRaisingEvents = $true
Write-Host "Daemon esta vivo! Escuchando $codigo"

while($true) {
    Wait-Event -Timeout 1
}

finally
{
    $daemon.EnableRaisingEvents = $false
    $handlers | ForEach-Object {
        Unregister-Event -SourceIdentifier $_.Name
    }

    $handlers | Remove-Jod

    $daemon.Dispose()

    Write-Warning "Gracias, vuelva prontos"
}
