#! /bin/bash

##-----------------------Inicio Encabezado----------------------------##
# Nombre Script: "script"
# Numero Trabajo Practico: 1
# Numero Ejercicio: 3
# Tipo 2da REentrega
#
# Apellido y Nombre     DNI
# --------------------- -----------
# Ayala Fernando Ariel, 36.238.748
# Cascasi Axel Joel,    42.200.104
# Castellana Julian,    42.252.533
# Mansilla Agustin,     41.257.066
# Turri Teo Francis,    42.819.058
##-----------------------Fin del Encabezado---------------------------##

helper() {
    echo ""
    echo "---Opciones---"
    echo "-?, -h, --help Muestra la ayuda para utilizar el daemon"
    echo "-c Directorio o path a monitorear cambios recursivamente"
    echo "-a Acciones, separadas por coma, a tomar cuando ocurra un evento, las opciones son: listar,peso,compilar,publicar"
    echo "-s Directorio a publicar la salida. Crea el directorio si es necesario. Requiere la accion Compilar"
    echo "--------------"
    exit -1
}

if [ $# -eq 0 ]; then
    echo "Sin argumentos no puedo correr!"
    helper
fi

ACTIONS=()

validateActions() {
   
    for i in ${1//,/ }; do
        case $i in
            listar|peso|compilar|publicar)
                ACTIONS+=("$i");;
            *)
                echo "Accion '$i' no valida!"
                helper;;
        esac
    done
}    


checkPermissions() {
    
    for modFile in `find $1 -printf "%M "`; do
        if [[ ! "${modFile:1:1}" == 'r' ]]; then
            echo "Checkear los permisos de lectura en el directorio a monitorear."
            exit 1
        fi
    done
}

while getopts ":c:a:s:h" param; do
    case $param in
        c)
            c="$OPTARG" #Directorio a monitorear cambios
            checkPermissions "$c";;
        s)
            s="$OPTARG";; #Directorio de salida
        a)
            a="$OPTARG" #Acciones a tomar con los cambios
            validateActions "$a";;
        h)
            helper;;
        help)
            helper;;
        *)
            if [[ ${OPTARG} == '?' || ${OPTARG} == '-' ]]; then
                helper
            else
                echo "Argumento invalido: ${OPTARG}"
                helper
            fi;;
    esac
done

validateParams() {
    valErr=0
    if [[ -z "$a" ]]; then
        valErr=1
        echo "Sin acciones no se puede ejecutar el demonio"
    fi 

    if [[ -z "$c" ]]; then
        valErr=1
        echo "Se requiere un directorio de monitoreo -c"
    fi
    
    if [[ "${ACTIONS[*]}" =~ "publicar" ]]; then
        if [[ -z "$s" ]]; then
            valErr=1
            echo "La accion publicar requiere un directorio de salida -s"
        fi
        
        if [[ ! "${ACTIONS[*]}" =~ "compilar" ]]; then
            valErr=1
            echo "La accion publicar requiere de la accion compilar"
        fi
    fi

    if [[ "$valErr" -eq "1" ]]; then
        helper
    fi
    
}


actionHandler() {

    while read IN; do
        if [[ "$IN" == *"$c"* ]]; then
            FILENAME=$(echo "$IN" | awk '{print $1$3}')
            if [[ "${ACTIONS[*]}" =~ "listar" ]]; then
                listar "$FILENAME"
            fi
    
            if [[ "${ACTIONS[*]}" =~ "peso" ]]; then
                peso "$FILENAME"
            fi

            if [[ "${ACTIONS[*]}" =~ "compilar" ]]; then
                compilar "$c"; 
                if [[ "${ACTIONS[*]}" =~ "publicar" ]]; then
                    publicar "$s";
                fi
            fi
        elif [[ "$IN" == "Watches established." ]]; then
            echo -e "\nDaemon esta vivo!"
            if [[ "${ACTIONS[*]}" =~ "compilar" ]]; then
                compilar "$c"; 
                if [[ "${ACTIONS[*]}" =~ "publicar" ]]; then
                    publicar "$s";
                fi
            fi
        fi
    done
}

listar() {
    echo -e "File: \n$1"
}

peso() {
    echo "Size: "
    if test -f "$1"; then
        wc -c < "$1";
    else
        echo "You deleted it monster..."
    fi

}

compilar() {
    #if file exist remove
    if [[ -e ./bin/output.txt ]]; then
        rm ./bin/output.txt
    fi
    #create output file
    mkdir -p ./bin
    touch ./bin/output.txt
    
    find "$1" -type f -name '*' -exec cat {} + >> './bin/output.txt';
}

publicar() {
    if [[ ! -e "$1" ]]; then
        mkdir -p "$1"
    fi
    cp ./bin/output.txt "$1";
}

validateParams

nohup inotifywait -m -r -e create,modify,delete $c 2>&1 | actionHandler &
