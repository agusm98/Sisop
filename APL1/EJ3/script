#! /bin/bash

#TODO --help: show n exit

helper() {
    echo ""
    echo "Options"
    echo "-?, -h, --help Output some helpful usage information"
    echo "-c Path to monitor recursively"
    echo "-a Actions to take when an event occurs. All Options call example: listar,peso,compilar,publicar"
    echo "-s Path to publish. Creates the directory if needed. Requires Compilar action"
    echo ""
    exit -1
}

if [ $# -eq 0 ]; then
    echo "No arguments, cant run!"
    helper
fi

ACTIONS=()

while getopts ":c:a:s:h" param; do
    case $param in
        c)
            c=$OPTARG;; #Directorio a monitorear cambios
        a)
            a=$OPTARG #Acciones a tomar con los cambios
            IFS=',' read -r -a ACTIONS <<< "$a";;
        s)
            s=$OPTARG;; #Directorio de salida
        h)
            helper;;
        help)
            helper;;
        *)
            if [[ ${OPTARG} == '?' || ${OPTARG} == '-' ]]; then
                helper
            else
                echo "Invalid argunment ${OPTARG} cant run!"
                helper
            fi;;
   esac
done

unset IFS;

actionHandler() {

    while read IN; do
        if [[ "$IN" == *"$c"* ]]; then
            FILENAME=$(echo "$IN" | awk '{print $1$3}')
            if [[ "${ACTIONS[*]}" =~ "listar" ]]; then
                listar $FILENAME
            fi
    
            if [[ "${ACTIONS[*]}" =~ "peso" ]]; then
                peso $FILENAME
            fi

            if [[ "${ACTIONS[*]}" =~ "compilar" ]]; then
                compilar $c; 
                if [[ "${ACTIONS[*]}" =~ "publicar" ]]; then
                    publicar $s;
                fi
            fi
        else
            echo "Daemon output: $IN"
        fi
    done
}

listar() {
    echo "File: $1"
}

peso() {
    if test -f "$i"; then
        echo "Size: "
        wc -c < "$i"
    fi
}

compilar() {
    #if file exist remove
    if [[ -e ./bin/output.txt ]]; then
        rm ./bin/output.txt
    fi
    #create output file
    mkdir -p ./bin
    touch ./bin/output.txt
    
    find $1 -type f -name '*' -exec cat {} + >> './bin/output.txt';
}

publicar() {
    if [[ ! -e "$1" ]]; then
        mkdir -p "$1"
    fi
    cp ./bin/output.txt $1;
}

inotifywait -m -r -e create,modify,delete $c | actionHandler &
